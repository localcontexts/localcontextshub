{% load static %}
<style>
    .region-container{
        margin-top: 20px;
    }
    .region-results-wrapper{
        position: relative;
    }
    .region-results{
        max-height: 190px;
        background: white;
        overflow-y: scroll;
        position: absolute;
        width: 100%;
        border: solid 1px #d9d1d1;
        border-radius: 2px;
        border-top: transparent;
        z-index: 1;
    }
    .result-item{
        padding-top: 5px;
        padding-left: 20px;
        padding-bottom: 5px;
        background: white;
        transition: 0.3s;
        cursor: pointer;
        user-select: none;
    }
    .result-item:hover {
        background: #d7e7e4;
    }

    .selected-title{
        padding: 12px;
        border: 3px solid #007385;
        background: aliceblue;
        border-radius: 5px;
        user-select: none;
    }
    .selected-title-ellipsis{
        width: 430px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .selected-title-wrapper{
        position: relative;
    }
    .nld-link{
        right: 8px;
        position: absolute;
        top: 14px;
        font-weight: bold;
        color: #007385;
        cursor: pointer;
    }

    .community-boundary-search {
        position: relative;
    }

    .community-boundary-search input{
        width: 100%;
        padding: 20px;
    }

    .community-boundary-search i{
        position: absolute;
        right: 10px;
        top: 14px;
    }

    .hidden{
        visibility: hidden;
    }

    #browse-files-btn{
        margin-left: 6px;
        width: 120px
    }
    .browse-files-container{
        margin-top: 10px;
    }

    #community-boundary-upload {
        position: relative;
        display: flex;
    }

    #community-boundary-upload input{
        width: calc(100% - 120px);
        padding: 24px;
        padding-left: 10px;
        cursor: pointer;
    }

    #community-boundary-search i{
        position: absolute;
        right: 10px;
        top: 14px;
    }

    .feedback {
        display: flex;
        padding: 16px;
        border-radius: 8px;
        width: max-content;
        margin-top: 8px;
    }
    .feedback i{
        font-size: 24px;
        margin-right: 12px;
    }
    .save-cancel-container {
        margin-top: 20px;
    }
</style>
<span class="boundary-selection-unit">
    <div class="region-container">
        <label class="pad-top-1-5">Search the Native Land Digital database</label><br>
        <div class="community-boundary-search">
            <input class="input-field search" type="text"
                   placeholder="Search by address, community name or town"
            >
            <i class="fa fa-search icon"></i>
        </div>
        <div class="region-results-wrapper">
            <div class="region-results"></div>
        </div>
    </div>
    <div class="browse-files-container">
                <label class="pad-top-1-5">Upload shape file (. zip)</label><br>
                <div id="community-boundary-upload">
                    <input class="input-field" type="text"
                           id="select-file-input"
                           placeholder="Select file"
                           readonly
                           onclick="triggerShapeFileInput()"
                    >
                    <div
                        id="browse-files-btn"
                        class="primary-btn action-btn"
                        onclick="triggerShapeFileInput()"
                    >
                        Browse files
                    </div>
                    <input
                        type="file" id="shapefile-input" name="shapefile" style="display: none"
                        onchange="uploadShapeFileData(this)"
                        accept=".zip"
                    >
                </div>
            </div>
    <div class="selected-location">
            <br>
            <strong>
                <label class="pad-top-1-5">Selected Location</label>
            </strong><br>

            <div class="selected-title-wrapper">
                <div class="selected-title">Place Holder</div>
                <a class="nld-link" target="_blank">
                    View Location in NLD &nbsp;
                    <i class="fa fa-arrow-up-right-from-square"></i>
                </a>
            </div>

        </div>
    <div class="save-cancel-container w-90 flex-this flex-start">
        <div>
            <a
                id="community-boundary-continue-btn"
                class="primary-btn action-btn disabled-btn margin-right-8"
                href="{% url 'confirm-community' %}"
                onclick="event.preventDefault()"
            >
                Change Boundaries
            </a>
        </div>
        <div id="skip-this-step">
            <a class="primary-btn white-btn" href="{% url 'confirm-community' %}">Cancel</a>
        </div>
    </div>
</span>
<script>
  fetch('https://native-land.ca/wp-json/nativeland/v1/map-list').then(resp => resp.json()).then(response => {

    document.querySelector('.region-container input.search').addEventListener("keyup", (event) => {
        let html = ''
        const textInput = event.target.value
        const inputLength = textInput.length
        if (inputLength >= 3) {
            var results = response.filter(item => item.post_title.toLowerCase().indexOf(textInput.toLowerCase()) > -1);
            results.forEach(result => {
            html += `
                <div class="result-item" data-slug="${result.slug}" data-title="${result.post_title}" onclick="selectSlug(this)">
                ${result.post_title} (territories)</br />
                </div>
            `
            })
        } else if (inputLength === 0){
            html = ''
        }
        event.target.closest('.boundary-selection-unit').querySelector('.region-results').innerHTML = html
    })

  })

    const target = document.querySelector('.region-results')
    document.addEventListener('click', (event) => {
        const withinboundary = event.composedPath().includes(target)
        if (!withinboundary) {
            // click outside element
            hideSearchDropDown()
        }
    })

    function hideSearchDropDown() {
       document.querySelector('.region-results').innerHTML = ''
    }
    function showSelectedSlug() {
        document.querySelector('.selected-location').classList.remove('hidden')
    }
    function enableContinueButton(){
        document.querySelector('#community-boundary-continue-btn').classList.remove('disabled-btn')
    }

    function selectSlug(self) {
        const selectionUnit = self.closest('.boundary-selection-unit')
        const title = event.target.dataset.title
        const slug = event.target.dataset.slug
        const url = `https://native-land.ca/wp-content/themes/Native-Land-Theme/embed/embed.html?maps=territories&name=${slug}`
        selectionUnit.querySelector('.nld-link').setAttribute('href', url)
        selectionUnit.querySelector('.selected-title').innerHTML = `<div class="selected-title-ellipsis">${title} (territories)</div>`

        // set selected data for selection
        selectionUnit.querySelector('.selected-title').setAttribute('data-slug', slug)

        hideSearchDropDown()
        showSelectedSlug()
        enableContinueButton()
    }
</script>