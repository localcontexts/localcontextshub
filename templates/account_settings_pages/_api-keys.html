{% extends 'account-settings-base.html' %}{% load static %}

{% block account_settings %}
<div class="flex-this space-between">
    <div><h3 class="no-top-margin">API Key Manager</h3></div>
</div>
{% include 'partials/_alerts.html' %}
<p class="no-top-margin">Generating API Keys enables access to the Local Contexts Hub database. Keep these keys confidential. For more information see our <a class="default-a" href="https://localcontexts.org/api-guide/" target="_blank">API Guide</a>.</p>

<div class="flex-this">
    <p class="subscription-counter"><span class="bold">API Keys Remaining:</span> {% if subscription_api_key_count == -1 and institution.is_subscribed %}Unlimited{% elif institution.is_subscribed %}{{ subscription_api_key_count }}{% else %}0{% endif %}</p>
</div>

{% if institution_keys %}
    <table class="projects-table">
        <tr>
            <th>Name</th>
            <th>API Key</th>
            <th>Copy</th>
            <th>Delete</th>
        </tr>

        {% for id, name, key in institution_keys %}
            <tr>
                <td class="bold">{{ name }}</td>
                <td id="{{ id }}">{{ key }}</td>
                <td><a id="copy-key" data-target="{{ id }}"><i class="fa-regular fa-clone pointer"></i></a></td>
                <td><a id="delete-key" data-target="{{ id }}"><i class="fa-regular fa-trash pointer"></i></a></td>
            </tr>
        {% endfor %}
    </table>
{% elif not institution_keys %}
    <p class="no-top-margin">You do not have an API key. Click the button below to generate one.</p>
{% endif %}

<div>
    <button id="generateAPIKeybtn" class="primary-btn action-btn margin-top-2"{% if not institution.is_subscribed or subscription_api_key_count == 0 %} title="{% if not institution.is_subscribed %}The subscription process of your institution is not completed yet.{% elif subscription_api_key_count == 0 %}Your institution has reached its API Key limit. Please delete an existing key or upgrade your subscription to add more keys.{% endif %}" disabled{% endif %}>Generate API Key</button>
</div>

<!-- Generate API Key Modal -->
<div id="generateAPIKeymodal" class="modal hide">

    <div class="modal-defaults share-modal flex-this column w-100">

        <div class="flex-this space-between">
            <div class="flex-this">
                <h2 class="primary-black-text no-top-margin">Generate API Key</h2>
            </div>
            <div>
                <div id='closegenerateAPIKeymodal' class="close-modal-btn pointer"><i class="fa-regular fa-xmark fa-xl"></i></div>
            </div>            
        </div>

        <div class="w-100">
            <div>
                <p class="no-top-margin">It's essential to keep your API keys secure and not share them publicly.</p>
            </div>

            <form id="apiKeyGeneratorForm" method="POST">
            {% csrf_token %}

            <div class="flex-this column w-100">
                <div class="margin-top-8">
                    <label>API Key Name</label><br>
                    {{ form.name }}
                    <div class="flex-this align-center space-between">
                        <div class="text-align-right margin-right-1">
                            <input type="checkbox" name="terms-agreement" required />
                        </div>
                        <div class="no-margin w-100">
                            <p>
                            <span>By checking this box, I am confirming that I have read & agree to the Local Contexts </span>
                            <a
                                href="#"
                                target="_blank"
                                rel="noopener"
                                class="default-a"
                            >API Terms</a>.
                            </p>
                        </div>
                    </div>
                    {% if form.name.errors %}
                        <div class="msg-red w-50"><small>{{ form.name.errors.as_text }}</small></div>
                    {% endif %}
                </div>
            </div>

            <div class="flex-this space-between w-100">
                <div class="w-100">
                    <button type="submit" class="primary-btn action-btn margin-top-2 w-100" name="generate_api_key">Generate API Key</button>
                </div>                    
            </div>

        </form>

        </div>
    </div>
</div>

<!-- Delete API Key Modal -->
<div id="deleteAPIKeymodal" class="modal hide">

    <div class="modal-defaults share-modal flex-this column w-100">

        <div class="flex-this space-between">
            <div class="flex-this">
                <h2 class="primary-black-text no-top-margin">Are you sure?</h2>
            </div>           
        </div>

        <div class="w-100">
            <div>
                <p class="no-top-margin">Are you sure you want to delete this API key? This key will no longer be able to connect to the API and can effect your applications using this API key.</p>
            </div>

            <div class="flex-this">
                <form id="deleteAPIKeyForm" method="POST">
                    {% csrf_token %}
                    <button id="continueAPIKeyDeletionBtn" class="primary-btn white-btn" name="delete_api_key" value="{{ id }}">Yes, delete this API Key.</button>
                </form>
                <div id="closedeleteAPIKeymodal" class="primary-btn action-btn margin-left-8">Cancel</div>
            </div>
        </div>
    </div>
</div>

<script>
    const copyBtns = document.querySelectorAll('#copy-key');
    copyBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            copyToClipboard(btn.dataset.target);
            btn.innerHTML = `<i class="fa-solid fa-check"></i>`;
            setTimeout(() => {
                btn.innerHTML = `<i class="fa-regular fa-clone pointer"></i>`
            }, 1000);
        });
    });

    const deleteBtns = document.querySelectorAll('#delete-key');
    const deleteAPIKeymodal = document.getElementById('deleteAPIKeymodal')
    deleteBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            if (deleteAPIKeymodal.classList.contains('hide')) { 
                deleteAPIKeymodal.classList.replace('hide', 'show')
                continueAPIKeyDeletionBtn.value = btn.dataset.target
            }
        });
    });
</script>
{% endblock %}